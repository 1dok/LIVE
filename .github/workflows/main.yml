name: Sync IPTV Playlists

on:
  schedule:
    - cron: '0 */2 * * *'        # æ¯ 2 å°æ—¶è§¦å‘ï¼ˆUTCï¼‰
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download and Update IPTV Playlists
        run: |
          set -e
          echo "ğŸµ å¼€å§‹ä¸‹è½½ IPTV æ’­æ”¾åˆ—è¡¨..."

          base="https://sub.ottiptv.cc"
          files=("iptv.m3u" "yylunbo.m3u" "huyayqk.m3u" "douyuyqk.m3u" "bililive.m3u")

          download_with_retry () {
            local url="$1"
            local outfile="$2"
            local tmpfile="${outfile}.tmp"
            local attempt=1
            local max=5

            rm -f "$tmpfile"
            while [ $attempt -le $max ]; do
              echo "â¡ï¸  [$attempt/$max] ä¸‹è½½ $outfile ..."
              if wget -q --timeout=15 --connect-timeout=10 "$url" -O "$tmpfile"; then
                if [ -s "$tmpfile" ]; then
                  mv "$tmpfile" "$outfile"
                  echo "âœ… $outfile ä¸‹è½½å¹¶è¦†ç›–å®Œæˆ"
                  return 0
                fi
              fi
              echo "âš ï¸  $outfile ä¸‹è½½å¤±è´¥ï¼Œç­‰å¾… $attempt ç§’åé‡è¯•..."
              sleep $attempt
              attempt=$(( attempt + 1 ))
            done

            echo "âŒ $outfile æœ€ç»ˆä¸‹è½½å¤±è´¥ï¼Œä¿ç•™æ—§ç‰ˆæœ¬"
            rm -f "$tmpfile"
            return 1
          }

          for f in "${files[@]}"; do
            download_with_retry "${base}/${f}" "$f" || true
          done

          echo "ğŸ“Š æ–‡ä»¶ä¸‹è½½çŠ¶
